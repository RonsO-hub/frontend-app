name: Jira Integration (Python Native)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */1 * * *'

jobs:
  run-integration:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Jira Integration
        run: pip install port-ocean-jira

      - name: Create Config File
        run: |
          cat <<EOF > port_ocean_config.yaml
          resources:
            - kind: issue
              selector:
                query: "ORDER BY created DESC"
              port:
                entity:
                  mappings:
                    identifier: .key
                    title: .fields.summary
                    blueprint: '"jiraIssue"'
                    properties:
                      status: .fields.status.name
                      assignee: .fields.assignee.displayName
                      description: .fields.description
                      priority: .fields.priority.name
                      link: .self
                      created_at: .fields.created
                      updated_at: .fields.updated
                    relations:
                      repository: .fields.components[].name
          EOF

      - name: Run Integration
        env:
          # We pass the secrets directly to the tool, bypassing the buggy wrapper
          PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
          PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
          PORT_BASE_URL: "https://api.port.io"
          OCEAN__INTEGRATION__CONFIG__JIRA_HOST: "https://solomonron.atlassian.net"
          OCEAN__INTEGRATION__CONFIG__ATLASSIAN_USER_EMAIL: "ron.solomon@cellebrite.com"
          OCEAN__INTEGRATION__CONFIG__ATLASSIAN_USER_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          ocean sail --type jira
