name: Jira Integration (Final Fix)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */1 * * *'

jobs:
  run-integration:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Create the Master Config File
      # We put all secrets and settings into this one file to guarantee the app sees them.
      - name: Create Config File
        run: |
          cat <<EOF > config.yaml
          port:
            client_id: "${{ secrets.PORT_CLIENT_ID }}"
            client_secret: "${{ secrets.PORT_CLIENT_SECRET }}"
            base_url: "https://api.port.io"
          integration:
            type: jira
            config:
              jira_host: "https://solomonron.atlassian.net"
              atlassian_user_email: "ron.solomon@cellebrite.com"
              atlassian_user_token: "${{ secrets.JIRA_API_TOKEN }}"
          resources:
            - kind: issue
              selector:
                query: "ORDER BY created DESC"
              port:
                entity:
                  mappings:
                    identifier: .key
                    title: .fields.summary
                    blueprint: '"jiraIssue"'
                    properties:
                      status: .fields.status.name
                      assignee: .fields.assignee.displayName
                      description: .fields.description
                      priority: .fields.priority.name
                      link: .self
                      created_at: .fields.created
                      updated_at: .fields.updated
                    relations:
                      repository: .fields.components[].name
          EOF

      # Step 2: Run Docker (Single Line Command)
      # We removed all backslashes to prevent the "argument" error.
      - name: Run Jira Integration
        run: docker run --rm -v $(pwd)/config.yaml:/app/config.yaml -e OCEAN__CONFIG__PATH="/app/config.yaml" ghcr.io/port-labs/port-ocean-jira:latest
