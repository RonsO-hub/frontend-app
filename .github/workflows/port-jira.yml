name: Jira Integration (Master Config)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */1 * * *'

jobs:
  run-integration:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Create a SINGLE file with ALL configurations (including secrets)
      - name: Create Complete Config
        run: |
          cat <<EOF > config.yaml
          port:
            client_id: "${{ secrets.PORT_CLIENT_ID }}"
            client_secret: "${{ secrets.PORT_CLIENT_SECRET }}"
            base_url: "https://api.port.io"
          
          integration:
            type: jira
            config:
              jira_host: "https://solomonron.atlassian.net"
              atlassian_user_email: "solomonron@gmail.com"
              atlassian_user_token: "${{ secrets.JIRA_API_TOKEN }}"
          
          resources:
            - kind: issue
              selector:
                query: "ORDER BY created DESC"
              port:
                entity:
                  mappings:
                    identifier: .key
                    title: .fields.summary
                    blueprint: '"jiraIssue"'
                    properties:
                      status: .fields.status.name
                      assignee: .fields.assignee.displayName
                      description: .fields.description
                      priority: .fields.priority.name
                      link: .self
                      created_at: .fields.created
                      updated_at: .fields.updated
                    relations:
                      repository: .fields.components[].name
          EOF

      # Step 2: Debug - Check if file exists (Optional but helpful)
      - name: Verify Config Creation
        run: ls -l config.yaml

      # Step 3: Run Docker with the Single Config File
      - name: Run Jira Integration
        run: |
          docker run --rm \
            -v $(pwd)/config.yaml:/app/config.yaml \
            -e OCEAN__CONFIG__PATH="/app/config.yaml" \
