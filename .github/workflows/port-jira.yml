name: Jira Integration (Docker Native)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */1 * * *'

jobs:
  run-integration:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Create the config file manually
      # This avoids the "whitespaces" error by writing the file directly
      - name: Create Config File
        run: |
          cat <<EOF > config.yaml
          jira_host: "https://solomonron.atlassian.net"
          atlassian_user_email: "solomonron@gmail.com"
          atlassian_user_token: "${{ secrets.JIRA_API_TOKEN }}"
          resources:
            - kind: issue
              selector:
                query: "ORDER BY created DESC"
              port:
                entity:
                  mappings:
                    identifier: .key
                    title: .fields.summary
                    blueprint: '"jiraIssue"'
                    properties:
                      status: .fields.status.name
                      assignee: .fields.assignee.displayName
                      description: .fields.description
                      priority: .fields.priority.name
                      link: .self
                      created_at: .fields.created
                      updated_at: .fields.updated
                    relations:
                      repository: .fields.components[].name
          EOF

      # Step 2: Run the container directly
      # We mount the config file we just made into the container
      - name: Run Jira Integration
        run: |
          docker run --rm \
            -v $(pwd)/config.yaml:/app/config.yaml \
            -e PORT_CLIENT_ID=${{ secrets.PORT_CLIENT_ID }} \
            -e PORT_CLIENT_SECRET=${{ secrets.PORT_CLIENT_SECRET }} \
            -e PORT_BASE_URL="https://api.port.io" \
            -e OCEAN__CONFIG__PATH="/app/config.yaml" \
            ghcr.io/port-labs/port-ocean-jira:latest
